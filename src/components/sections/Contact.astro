---
// Automatyczne przełączanie między dev i production
const IS_DEV = import.meta.env.DEV;

// Cloudflare Turnstile - testowy klucz dla localhost
const TURNSTILE_SITE_KEY = IS_DEV 
  ? '1x00000000000000000000AA' // Testowy klucz (zawsze sukces)
  : '0x4AAAAAAB6A2yJqViomFv4t'; // Produkcyjny klucz

const API_ENDPOINT = IS_DEV
  ? 'http://localhost:8787/api/contact'
  : 'https://kancelariakalinowska.pl/api/contact';
---

<section 
  id="kontakt" 
  class="section contact"
  data-api-endpoint={API_ENDPOINT}
  data-turnstile-key={TURNSTILE_SITE_KEY}
>
  <div class="container">
    <div class="section-header animate-on-scroll">
      <h2 class="section-title">Skontaktuj się z nami</h2>
      <p class="section-description">
        Świadczymy usługi na terenie Białegostoku, a także zdalnie. 
        <br> Skontaktuj się z nami, aby
        omówić swoją sprawę i poznać możliwe rozwiązania.
      </p>
    </div>
    <div class="contact-content">
      <div class="contact-info animate-on-scroll animate-left">
        <h3>Dane kontaktowe</h3>
        <div class="contact-details">
          <div class="contact-item">
            <h4>Adres kancelarii</h4>
            <p>ul. Złota 2 lok. 19<br />15-016 Białystok</p>
          </div>
          <div class="contact-item">
            <h4>Telefon</h4>
            <p><a href="tel:+48503606738">+48 503 606 738</a></p>
          </div>
          <div class="contact-item">
            <h4>Email</h4>
            <p>
              <a href="mailto:kontakt@kancelariakalinowska.pl"
                >kontakt@kancelariakalinowska.pl</a
              >
            </p>
          </div>
        </div>
        <div class="contact-item">
          <h4>Godziny pracy</h4>
          <p>
            Poniedziałek - Piątek: 8:00 - 17:00<br />Sobota: na umówienie<br
            />Niedziela: zamknięte
          </p>
        </div>
      </div>
      <div class="contact-form animate-on-scroll animate-right">
        <h3>Napisz do nas</h3>
        <p class="contact-form-subtitle">
          Opisz swoją sprawę, a skontaktujemy się z Tobą w ciągu 24 godzin.
        </p>
        
        <form id="contact-form">
          <!-- Honeypot (ukryte pole anty-spam) -->
          <input type="text" name="honeypot" id="honeypot" style="display:none" tabindex="-1" autocomplete="off" />
          
          <div class="form-row">
            <div class="form-group">
              <label for="name">Imię i nazwisko *</label>
              <input 
                type="text" 
                id="name" 
                name="name" 
                required 
                minlength="2"
                maxlength="100"
              />
            </div>
            <div class="form-group">
              <label for="email">Email *</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                required 
                maxlength="254"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="phone">Telefon</label>
              <input 
                type="tel" 
                id="phone" 
                name="phone" 
                maxlength="20"
              />
            </div>
            <div class="form-group">
              <label for="subject">Temat sprawy *</label>
              <input 
                type="text" 
                id="subject" 
                name="subject" 
                required 
                minlength="3"
                maxlength="200"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="message">Opis sprawy *</label>
            <textarea
              id="message"
              name="message"
              placeholder="Opisz swoją sprawę prawną..."
              required
              minlength="10"
              maxlength="5000"
              rows="6"></textarea>
          </div>
          
          <!-- Cloudflare Turnstile -->
          <div class="form-group">
            <div 
              id="turnstile-widget"
              class="cf-turnstile" 
              data-sitekey={TURNSTILE_SITE_KEY} 
              data-theme="light"
            ></div>
          </div>
          
          <div class="form-group">
            <p class="form-privacy-note">
              * Pola wymagane. Przesyłając formularz zgadzasz się na przetwarzanie danych osobowych 
              w celu udzielenia odpowiedzi na zapytanie zgodnie z naszą <a href="/polityka-prywatnosci">polityką prywatności</a>.
            </p>
          </div>
          
          <button type="submit" class="form-submit" id="submit-btn">
            <span class="btn-text">Wyślij wiadomość</span>
            <span class="btn-spinner" style="display: none;">Wysyłanie...</span>
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Toast container -->
<div id="toast-container" class="toast-container"></div>

<script>
  /**
   * Contact form handler
   * Handles form submission, Turnstile verification, and user feedback
   */
  
  interface FormElements {
    form: HTMLFormElement;
    submitBtn: HTMLButtonElement;
    btnText: HTMLElement;
    btnSpinner: HTMLElement;
  }

  interface ContactFormData {
    name: string;
    email: string;
    phone: string;
    subject: string;
    message: string;
    honeypot: string;
    'cf-turnstile-response': string;
  }

  interface ApiResponse {
    ok: boolean;
    error?: string;
    message?: string;
  }

  // Load Cloudflare Turnstile script
  function loadTurnstile(): void {
    if (document.querySelector('script[src*="turnstile"]')) {
      return; // Already loaded
    }

    const script = document.createElement('script');
    script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }

  // Get form elements
  function getFormElements(): FormElements | null {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    
    if (!form || !submitBtn) {
      console.error('Contact form elements not found');
      return null;
    }

    const btnText = submitBtn.querySelector('.btn-text') as HTMLElement;
    const btnSpinner = submitBtn.querySelector('.btn-spinner') as HTMLElement;

    if (!btnText || !btnSpinner) {
      console.error('Contact form sub-elements not found');
      return null;
    }

    return { form, submitBtn, btnText, btnSpinner };
  }

  // Toast notification system
  let toastIdCounter = 0;

  function showToast(
    type: 'success' | 'error',
    title: string,
    message: string,
    duration: number = 5000
  ): void {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toastId = `toast-${toastIdCounter++}`;
    const icon = type === 'success' ? '✓' : '✕';
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-content">
        <div class="toast-icon">${icon}</div>
        <div class="toast-text">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" aria-label="Zamknij">✕</button>
      </div>
      <div class="toast-progress-bar">
        <div class="toast-progress"></div>
      </div>
    `;

    container.appendChild(toast);

    // Set progress bar animation duration
    const progressBar = toast.querySelector('.toast-progress') as HTMLElement;
    if (progressBar) {
      progressBar.style.animationDuration = `${duration}ms`;
    }

    // Close button handler
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn?.addEventListener('click', () => removeToast(toastId));

    // Auto-remove after duration
    setTimeout(() => removeToast(toastId), duration);
  }

  function removeToast(toastId: string): void {
    const toast = document.getElementById(toastId);
    if (!toast) return;

    toast.classList.add('toast-hiding');
    
    // Remove from DOM after animation
    setTimeout(() => {
      toast.remove();
    }, 300);
  }

  // Toggle button loading state
  function setButtonLoading(
    elements: FormElements,
    isLoading: boolean
  ): void {
    elements.submitBtn.disabled = isLoading;
    elements.btnText.style.display = isLoading ? 'none' : 'inline';
    elements.btnSpinner.style.display = isLoading ? 'inline' : 'none';
  }

  // Collect form data
  function collectFormData(form: HTMLFormElement): ContactFormData {
    const formData = new FormData(form);
    const turnstileResponse = document.querySelector<HTMLInputElement>(
      '[name="cf-turnstile-response"]'
    )?.value || '';

    return {
      name: (formData.get('name') as string) || '',
      email: (formData.get('email') as string) || '',
      phone: (formData.get('phone') as string) || '',
      subject: (formData.get('subject') as string) || '',
      message: (formData.get('message') as string) || '',
      honeypot: (formData.get('honeypot') as string) || '',
      'cf-turnstile-response': turnstileResponse,
    };
  }

  // Submit form to API
  async function submitForm(
    apiEndpoint: string,
    data: ContactFormData
  ): Promise<ApiResponse> {
    const response = await fetch(apiEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    return response.json();
  }

  // Reset Turnstile widget
  function resetTurnstile(): void {
    if (window.turnstile) {
      const widget = document.getElementById('turnstile-widget');
      if (widget) {
        window.turnstile.reset();
      }
    }
  }

  // Handle form submission
  async function handleFormSubmit(
    event: Event,
    elements: FormElements,
    apiEndpoint: string
  ): Promise<void> {
    event.preventDefault();

    // Show loading state
    setButtonLoading(elements, true);

    try {
      // Collect and submit form data
      const data = collectFormData(elements.form);
      const result = await submitForm(apiEndpoint, data);

      // Handle response
      if (result.ok) {
        showToast(
          'success',
          'Wiadomość wysłana',
          'Dziękujemy za kontakt. Odpowiemy w ciągu 24 godzin.',
          8000
        );
        elements.form.reset();
        resetTurnstile();
      } else {
        showToast(
          'error',
          'Błąd wysyłania',
          result.error || 'Wystąpił błąd. Spróbuj ponownie.',
          10000
        );
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showToast(
        'error',
        'Błąd połączenia',
        'Nie można wysłać wiadomości. Sprawdź połączenie internetowe.',
        10000
      );
    } finally {
      setButtonLoading(elements, false);
    }
  }

  // Initialize contact form
  function initContactForm(): void {
    const section = document.getElementById('kontakt');
    if (!section) return;

    const apiEndpoint = section.dataset.apiEndpoint;
    if (!apiEndpoint) {
      console.error('API endpoint not configured');
      return;
    }

    const elements = getFormElements();
    if (!elements) return;

    // Load Turnstile
    loadTurnstile();

    // Attach form submit handler
    elements.form.addEventListener('submit', (event) =>
      handleFormSubmit(event, elements, apiEndpoint)
    );
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initContactForm);
  } else {
    initContactForm();
  }

  // Extend Window interface for TypeScript
  declare global {
    interface Window {
      turnstile?: {
        reset: (widgetId?: string) => void;
        render: (element: HTMLElement, options: any) => string;
      };
    }
  }
</script>
